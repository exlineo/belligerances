<header>
  <h1>{{ l.t['BATAILLES'] }} ({{ d.campagne!.nom }})</h1>
  <p>{{ l.t['BATAILLES_DESCR'] }}</p>
</header>
<section id="champ" cdkDropListGroup>
  <header>
    <form>
      <mat-form-field>
        <mat-label>{{ l.t['BATAILLES_BG'] }}</mat-label>
        <mat-select [placeholder]="l.t['BATAILLES_BG']" name="bg" [(ngModel)]="bg">
          @for(bg of d.params.cartes; track bg.id){
          <mat-option [value]="bg.img">
            <img [src]="bg.vignette" [alt]="bg.vignette">
            <article>
              <h5>{{ bg.description }}</h5>
            </article>
          </mat-option>
          }
        </mat-select>
      </mat-form-field>
      <!-- SLIDER -->
      <fieldset>
        <mat-label>{{ l.t['HEX_AFFICHE'] }}</mat-label>
        <mat-slider min="0" max="100" step="1" discrete (input)="matSlide($event)">
          <input matSliderThumb value="50">
        </mat-slider>
      </fieldset>
    </form>
  </header>
  <article class="map tokens" onDragBoundary="map" cdkDrop #map [style.backgroundImage]="'url('+bg+')'">
    @for(c of listeCompagnies; track c.id; let i=$index){
    <div [matTooltip]="c.nom" [matTooltipClass]="(attaque && c.id == attaque.id && i==indexAttaquant) ? 'tooltip' : ''"
      class="token compagnie" cdkDrag [id]="'c'+c.id" #token (contextmenu)="actions($event, c, i)"
      (mouseleave)="tokenLeave($event)">
      <!--  -->
      <img [src]="c.avatar" [alt]="c.nom">
      <span class="hex" [style.color]="d.docs.armees[c.armee!].couleur">&#x2B22;</span>
      <span [matBadge]="c.unites.length" matBadgeColor="warn"></span>
      @if(selected && c.id == selected.id && i==indexAttaquant){
      <div id="mb">
        <ul>
          <li><a [matTooltip]="l.t['ACT_CAC']" matTooltipPosition="right" (click)="actionBaston($event, c, 'ACT_CAC')">
              <img src="assets/images/pictos/action-cac_b.png" [alt]="l.t['ACT_CAC']"></a></li>

          <li><a [matTooltip]="l.t['ACT_JET']" matTooltipPosition="right">
              <img src="assets/images/pictos/action-jet_b.png" [alt]="l.t['ACT_JET']"
                (click)="actionBaston($event, c, 'ACT_JET')"></a></li>

          <!-- <li><a [matTooltip]="l.t['ACT_SORT']" matTooltipPosition="below">
              <img src="assets/images/pictos/action-sort_b.png" [alt]="l.t['ACT_SORT']" (click)="actionBaston($event, c, 'ACT_SORT')"></a></li> -->

          <li><a [matTooltip]="l.t['ACT_RALLIE']" matTooltipPosition="below" (click)="actionRallie(c)">
              <img src="assets/images/pictos/action-rallie_b.png" [alt]="l.t['ACT_RALLIE']"></a></li>

          <!-- <li><a [matTooltip]="l.t['ACT_MORAL']" matTooltipPosition="left">
              <img src="assets/images/pictos/action-moral_b.png" [alt]="l.t['ACT_MORAL']"></a></li> -->

          <li><a [matTooltip]="l.t['DEL']" matTooltipPosition="left" (click)="actionDel($event, i, c.id)">
              <img src="assets/images/pictos/action-del_b.png" [alt]="l.t['DEL']"></a></li>

          <li><a [matTooltip]="l.t['ACT_INFOS']" matTooltipPosition="above" (click)="actionInfos(c)">
              <img src="assets/images/pictos/action-infos_b.png" [alt]="l.t['ACT_STATUT']"></a></li>

          <li><a [matTooltip]="l.t['ACT_DEF']" matTooltipPosition="after" (click)="actionDefend(c)">
              <img src="assets/images/pictos/action-statut_b.png" [alt]="l.t['ACT_DEF']"></a></li>


          <li><a [matTooltip]="l.t['ACT_DEFI_AT']" matTooltipPosition="above" (click)="actionDefi(c.id, true)">
              <img src="assets/images/pictos/action-officierAt_b.png" [alt]="l.t['ACT_DEFI_AT']"></a></li>

          <li><a [matTooltip]="l.t['ACT_DEFI_DEF']" matTooltipPosition="above" (click)="actionDefi(c.id, false)">
              <img src="assets/images/pictos/action-officierDef_b.png" [alt]="l.t['ACT_DEFI_DEF']"></a></li>

        </ul>
      </div>
      }
    </div>
    }
    <div id="hexagones" [style.opacity]="opacite"></div>
  </article>
</section>
<!-- OPTION LATTERALES -->
<aside>
  <section [@tabOuvre]="tabArmees ? 'ferme' : 'ouvre'">
    <header>
      <a (click)="tabArmees = !tabArmees">
        <img src="assets/images/pictos/armoiries.png" [alt]="l.t['ARMEES']">
        <p>{{ l.t['ARMEES'] }}</p>
      </a>
    </header>
    <mat-accordion>
      @for(a of d.docs.armees; track a.id; let i=$index){
      <mat-expansion-panel [class]="drag ? 'overflow' : ''">
        <mat-expansion-panel-header>
          <mat-panel-title>
            @if(a.avatar){
            <img [src]="a.avatar" [alt]="a.nom" class="avatar">
            }
            <h5>{{ a.nom }}</h5>
          </mat-panel-title>
        </mat-expansion-panel-header>
        <article class="col panneau">
          <p>{{ a.descr }}</p>
          @for(c of a.compagnies; track c; let j=$index){
          <div>
            <div class="token" cdkDrag (cdkDragEnded)="tokenDrop($event, d.docs.compagnies[c])"
              (cdkDragMoved)="setDragOverflow()" [matTooltip]="d.docs.compagnies[c].nom">
              <img [src]="d.docs.compagnies[c].avatar" [alt]="d.docs.compagnies[c].nom">
              <span class="hex" [style.color]="a.couleur">&#x2B22;</span>
            </div>
            <div>
              <h5>{{ d.docs.compagnies[c].nom }}</h5>
              <p>{{ l.t['UNITES'] }} : {{ d.docs.compagnies[c].unites.length }}</p>
            </div>
          </div>
          }
        </article>
      </mat-expansion-panel>
      }
    </mat-accordion>
  </section>
</aside>
<!-- OPTIONS DES BATAILLES -->
<footer>
  <section [@tabLeve]="tabActions ? 'leve' : 'baisse'">
    <header>
      <a (click)="tabActions = !tabActions">
        <img src="assets/images/pictos/action.png" [alt]="l.t['ACTS']">
        <p>{{ l.t['ACTS'] }}</p>
      </a>
    </header>
    <section>
      <article>
        <!-- Compagnie attaque -->
        @if(attaque){
        <h4>{{ l.t['ATTAQUANT'] }}</h4>
        <h5>{{ attaque.nom }}</h5>
        <ul>
          <li>
            <img src="assets/images/pictos/unite-bouclier_n.png" [alt]="l.t['COMBATTANTS']">
            <span>{{ l.t['UNITES'] }}</span>
            <span>{{ attaque.unites.length }}</span>
          </li>
          <li>
            <img src="assets/images/pictos/trauma_n.png" [alt]="l.t['COMBATTANTS']">
            <span>{{ l.t['BLESSES'] }}</span>
            <span>{{ attaque.blesses }}</span>
          </li>
          <li>
            <img src="assets/images/pictos/morts_n.png" [alt]="l.t['COMBATTANTS']">
            <span>{{ l.t['MORTS'] }}</span>
            <span>{{ attaque.morts }}</span>
          </li>
          <li>
            <img src="assets/images/pictos/action-moral_n.png" [alt]="l.t['ACT_MORAL']">
            <span>{{ l.t['MORAL'] }}</span>
            <span>{{ attaque.moral }}</span>
          </li>

        </ul>
        @if(action == 'ACT_JET' || action == 'ACT_SORT' || (officierAt && officierAt.jet && officierAt.jet != -1)){
          <mat-form-field>
            <mat-label>{{ l.t['JET'] }}</mat-label>
            <input matInput [placeholder]="l.t['JET']" name="distance" [(ngModel)]="distance" type="number">
            <mat-icon matSuffix>straighten</mat-icon>
          </mat-form-field>
        }
        }
        <!-- Commandant attaque -->
        @if(officierAt){
        <h4>{{ l.t['ATTAQUANT'] }}</h4>
        <h5>{{ officierAt.nom }}</h5>
        <ul>
          <li>
            <img src="assets/images/pictos/coeur_n.png" [alt]="l.t['PV']">
            <span>{{ l.t['PV'] }}</span>
            <span [matBadge]="blesses" matBadgeColor="warn"><strong>{{ officierAt.pv }}</strong></span>
          </li>
          @if(officierAt.cac){
          <li>
            <img src="assets/images/pictos/action-cac_n.png" [alt]="l.t['CAC']">
            <span>{{ l.t['CAC'] }}</span>
            <span><strong>{{ d.getCompagniesUnites('cac', officierAt.cac!).nom }}</strong></span>
          </li>
          }
          @if(officierAt.monture){
          <li>
            <img src="assets/images/pictos/cavalerie_n.png" [alt]="l.t['MONTURE']">
            <span>{{ l.t['BLESSES'] }}</span>
            <span><strong>{{ d.getCompagniesUnites('montures', officierAt.monture!).nom }}</strong></span>
          </li>
          }
        </ul>
        <ul>
          <li>
            <img src="assets/images/pictos/armor_pn.png" [alt]="l.t['ARMURE']">
            <span>{{ l.t['ARMURE'] }}</span>
            <span><strong>{{ d.getCompagniesUnites('armures', officierAt.armure!).nom }}</strong></span>
          </li>
          <li>
            <img src="assets/images/pictos/shield_pn.png" [alt]="l.t['BOUCLIER']">
            <span>{{ l.t['BOUCLIER'] }}</span>
            <span><strong>{{ d.getCompagniesUnites('boucliers', officierAt.bouclier!).nom }}</strong></span>
          </li>
          <li>
            <img [src]="officierAt.etat | statuts" [alt]="officierAt.nom" [alt]="l.t['STATUT']">
          </li>
        </ul>
        }
        @if(!attaque && !officierAt) {
        <h3>{{ l.t['AT_CHOIX'] }}</h3>
        }
      </article>
      <span>
        <button class="valide" [matTooltip]="l.t[action]" (click)="goCombat()">
          <img src="assets/images/pictos/action_b.png" [alt]="l.t['ACTS']">
          <!-- <span>{{ l.t['ACT_AT'] }}</span> -->
        </button>
      </span>
      <article>
        @if(defend){
        <h4>{{ l.t['DEFENSEUR'] }}</h4>
        <h5>{{ defend.nom }}</h5>
        <ul>
          <li>
            <img src="assets/images/pictos/unite-bouclier_n.png" [alt]="l.t['COMBATTANTS']">
            <span>{{ l.t['UNITES'] }}</span>
            <span><strong>{{ defend.unites.length }}</strong></span>
          </li>
          <li [matBadge]="blesses" matBadgeColor="warn">
            <img src="assets/images/pictos/trauma_n.png" [alt]="l.t['COMBATTANTS']">
            <span>{{ l.t['BLESSES'] }}</span>
            <span><strong>{{ defend.blesses }}</strong></span>
          </li>
          <li [matBadge]="morts" matBadgeColor="warn">
            <img src="assets/images/pictos/morts_n.png" [alt]="l.t['COMBATTANTS']">
            <span>{{ l.t['MORTS'] }}</span>
            <span><strong>{{ defend.morts }}</strong></span>
          </li>
          <li>
            <img src="assets/images/pictos/action-moral_b.png" [alt]="l.t['ACT_MORAL']">
            <span>{{ l.t['MORAL'] }}</span>
            <span><strong>{{ defend.moral }}</strong></span>
          </li>
        </ul>
        }
        <!-- COMMANDANT ATTAQUE -->
        @if(officierDef){
        <h4>{{ l.t['DEFENSEUR'] }}</h4>
        <h5>{{ officierDef.nom }}</h5>
        <ul>
          <li>
            <img src="assets/images/pictos/coeur_n.png" [alt]="l.t['PV']">
            <span>{{ l.t['PV'] }}</span>
            <span [matBadge]="morts" matBadgeColor="warn"><strong>{{ officierDef.pv }}</strong></span>
          </li>
          @if(officierDef.cac){
          <li>
            <img src="assets/images/pictos/action-cac_n.png" [alt]="l.t['CAC']">
            <span>{{ l.t['CAC'] }}</span>
            <span><strong>{{ d.getCompagniesUnites('cac', officierDef.cac!).nom }}</strong></span>
          </li>
          }
          @if(officierDef.monture){
          <li>
            <img src="assets/images/pictos/cavalerie_n.png" [alt]="l.t['MONTURE']">
            <span>{{ l.t['BLESSES'] }}</span>
            <span><strong>{{ d.getCompagniesUnites('montures', officierDef.monture!).nom }}</strong></span>
          </li>
          }
        </ul>
        <ul>
          <li>
            <img src="assets/images/pictos/armor_pn.png" [alt]="l.t['ARMURE']">
            <span>{{ l.t['ARMURE'] }}</span>
            <span><strong>{{ d.getCompagniesUnites('armures', officierDef.armure!).nom }}</strong></span>
          </li>
          <li>
            <img src="assets/images/pictos/shield_pn.png" [alt]="l.t['BOUCLIER']">
            <span>{{ l.t['BOUCLIER'] }}</span>
            <span><strong>{{ d.getCompagniesUnites('boucliers', officierDef.bouclier!).nom }}</strong></span>
          </li>
          <li>
            <img [src]="officierDef.etat | statuts" [alt]="officierDef!.nom" [alt]="l.t['STATUT']">
          </li>
        </ul>
        }
        @if(!defend && !officierDef) {
        <h3>{{ l.t['DEF_CHOIX'] }}</h3>
        }
      </article>
    </section>
  </section>
</footer>
@if(infos){
<section id="pop">
  <main>
    <header>
      <a (click)="infos = false" [title]="l.t['FERMER']" class="close"><mat-icon>close</mat-icon></a>
      <h2>{{ l.t['COMPAGNIE'] }} : {{ selected!.nom }}</h2>
      <p>{{ selected!.descr }}</p>
    </header>
    <section>
      <table>
        <thead>
          <tr>
            <th>{{ l.t['COMMANDANT'] }}</th>
            <th>{{ l.t['ARMEE'] }}</th>
            <th>{{ l.t['PV'] }}</th>
            <th>{{ l.t['MORAL'] }}</th>
            <th colspan="2">{{ l.t['MUNS'] }}</th>
            <th>{{ l.t['STATUT'] }}</th>
          </tr>
          <tr>
            <th colspan="4"></th>
            <th>{{ l.t['TYPE'] }}</th>
            <th>{{ l.t['QT'] }}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ d.getCompagniesUnites('unites', selected!.commandant).nom }}</td>
            <td>{{ d.getCompagniesUnites('armees', selected!.armee!).nom }}</td>
            <td>{{ selected!.pv }}</td>
            <td>{{ selected!.moral }}</td>
            <td>{{ selected!.munitions?.type }}</td>
            <td>{{ selected!.munitions?.q }}</td>
            <td><img [src]="selected!.statut | statuts" [alt]="selected!.nom"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <thead>
          <tr>
            <td>{{ l.t['NOM'] }}</td>
            <td>{{ l.t['RACE'] }}</td>
            <td>{{ l.t['CAC'] }}</td>
            <td>{{ l.t['JET'] }}</td>
            <td>{{ l.t['ARMURE'] }}</td>
            <td>{{ l.t['BOUCLIER'] }}</td>
            <td>{{ l.t['PV_MAX'] }}</td>
            <td>{{ l.t['PV'] }}</td>
            <td>{{ l.t['MONTURE'] }}</td>
            <td>{{ l.t['XP'] }}</td>
            <td>{{ l.t['STATUT'] }}</td>
          </tr>
        </thead>
        <tbody>
          @for (u of selected!.unites | slice:pagination.min:pagination.max; track $index) {
          <tr>
            <td>{{ d.getCompagniesUnites('unites', u).nom }}</td>
            <td>{{ d.getCompagniesUnites('races', u).nom }}</td>
            <td>{{ d.getCompagniesUnites('cac', u).nom }}</td>
            <td>{{ d.getCompagniesUnites('jet', u).nom }}</td>
            <td>{{ d.getCompagniesUnites('armures', u).nom }}</td>
            <td>{{ d.getCompagniesUnites('boucliers', u).nom }}</td>
            <td>{{ d.getCompagniesUnites('unites', u).pvMax }}</td>
            <td>{{ d.getCompagniesUnites('unites', u).pv }}</td>

            <td>{{ d.getCompagniesUnites('montures', u).nom }}</td>
            <td>{{ d.getCompagniesUnites('unites', u).xp }}</td>
            <td><img [src]="d.getCompagniesUnites('unites', u).etat | statuts" [alt]="l.t['AVATAR']"></td>
          </tr>
          }
        </tbody>
      </table>
      <mat-paginator [length]="selected?.unites?.length" (page)="setPagination($event)" [pageSize]="10"
        [pageSizeOptions]="[10, 25, 50, 100, 250]" aria-label="Avancer dans les unitées">
      </mat-paginator>
    </section>
  </main>
</section>
}
